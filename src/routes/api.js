const router=require("express").Router(),database=require("./../database"),planets=require("./../API/planets.json");router.get("/",async(e,a,r)=>{a.render("api",{user:e.user,keys:{...await database.database.get(`api/users/${e.user.googleId}/keys`)},url:"https://"+e.get("host")})}),router.get("/try/:type",async(e,a,r)=>{e.params.type||a.json({errorMessage:"Para realizar testes com a API, voc\xea precisa definir o tipo da fun\xe7\xe3o."});let t=["cpf","cnpj","cep","filme","serie","letra"];t.includes(e.params.type)||a.json({errorMessage:"Essa fun\xe7\xe3o da API n\xe3o \xe9 v\xe1lida."}),["cpf","cnpj","cep"].includes(e.params.type)?a.render("vec",{user:e.user}):a.render("bd",{user:e.user})}),router.get("/:id?/:secret?/:type?",async(e,a,r)=>{let t=e.params.id,s=e.params.secret,o=e.params.type,n=e.query.value,i=["planetas","abreviar","cpf","cnpj","cep","filme","serie","letra","musica",];if(!await database.database.get(`api/users/${t}`))return a.json({errorMessage:"N\xe3o foi poss\xedvel encontrar o seu ID."});if("admin"===t)return a.json({errorMessage:"N\xe3o tente se passar por um administrador."});if(await database.database.get(`api/users/${t}/keys/apiKey`)!==s&&await database.database.get(`api/users/${t}/keys/apiKey`)!=="admin")return a.json({errorMessage:"N\xe3o foi poss\xedvel encontrar a sua chave da API, ou ela n\xe3o coincide com a chave desse ID."});if(!i.includes(o))return a.json({errorMessage:"N\xe3o foi poss\xedvel encontrar a API que voc\xea quer utilizar."});if("planetas"!=o&&!n)return a.json({errorMessage:"N\xe3o foi poss\xedvel encontrar o par\xe2metro de valor na URL."});switch(o){case"planetas":a.json({...planets});break;case"abreviar":function c(e){var a=e.toString().replace(/[^0-9.]/g,"");if(999>parseFloat(a=a.replace(/\./g,"")))return a;for(var r=Math.abs(parseFloat(a)),t=Math.floor(Math.max(0,r.toString().length-1)/3),s="",o=2;o>=1&&!(((s=parseFloat((0!=t?r/Math.pow(1e3,t):r).toPrecision(o)))+"").replace(/[^0-9]+/g,"").length<=2);o--);return s%1!=0&&(s=s.toFixed(1)),(0>parseFloat(a)?"-":"")+s+["","k","m","b","t","q","aa","ab","ac","ad","ae","af","ag",][t]}a.json({response:c(n)});break;case"cpf":function u(e){let a=e.replace(/\D/g,"");if(11!==a.length||/^(\d)\1+$/.test(a))return{response:!1,info:"CPF inv\xe1lido"};let r=0;for(let t=0;t<9;t++)r+=parseInt(a.charAt(t))*(10-t);let s=10*r%11;if((s=10===s?0:s)!==parseInt(a.charAt(9)))return{response:!1,info:"CPF inv\xe1lido"};r=0;for(let o=0;o<10;o++)r+=parseInt(a.charAt(o))*(11-o);if((s=10==(s=10*r%11)?0:s)!==parseInt(a.charAt(10)))return{response:!1,info:"CPF inv\xe1lido"};let n=l(a.charAt(8));return{response:!0,info:`CPF v\xe1lido. Pertence ao estado de ${n}.`}}function l(e){switch(e){case"0":return"Rio Grande do Sul";case"1":return"Distrito Federal, Goi\xe1s, Mato Grosso do Sul ou Tocantins";case"2":return"Amazonas, Par\xe1, Roraima, Amap\xe1, Acre ou Rond\xf4nia";case"3":return"Cear\xe1, Maranh\xe3o ou Piau\xed";case"4":return"Para\xedba, Pernambuco, Alagoas ou Rio Grande do Norte";case"5":return"Bahia ou Sergipe";case"6":return"Minas Gerais";case"7":return"Rio de Janeiro ou Esp\xedrito Santo";case"8":return"S\xe3o Paulo";case"9":return"Paran\xe1 ou Santa Catarina";default:return"Estado n\xe3o identificado"}}a.json(u(n));break;case"cnpj":function p(e){let a=e.replace(/\D/g,"");if(14!==a.length||/^(\d)\1+$/.test(a))return!1;let r=a.length-2,t=a.substring(0,r),s=a.substring(r),o=0,n=r-7;for(let i=r;i>=1;i--)o+=parseInt(t.charAt(r-i))*n--,n<2&&(n=9);let c=o%11<2?0:11-o%11;if(c!==parseInt(s.charAt(0)))return!1;r+=1,t=a.substring(0,r),o=0,n=r-7;for(let u=r;u>=1;u--)o+=parseInt(t.charAt(r-u))*n--,n<2&&(n=9);return(c=o%11<2?0:11-o%11)===parseInt(s.charAt(1))}a.json({response:p(n)});break;case"cep":async function d(e){let a=e.replace(/\D/g,"");try{let r=await fetch(`https://viacep.com.br/ws/${a}/json/`),t=await r.json();if(r.ok)return{success:!0,data:{cep:t.cep,logradouro:t.logradouro,complemento:t.complemento,bairro:t.bairro,localidade:t.localidade,uf:t.uf,ibge:t.ibge}};return{success:!1,error:"CEP n\xe3o encontrado"}}catch(s){return{success:!1,error:"Erro na consulta"}}}d(n).then(e=>a.json({...e}));break;case"filme":async function g(e){let a="4e00066c2a5ca6f1b85b62150b3e5725",r=`https://api.themoviedb.org/3/genre/movie/list?api_key=${a}&language=pt-BR`,t=await fetch(r),s=await t.json(),o=s.genres||[],n=`https://api.themoviedb.org/3/search/movie?api_key=${a}&query=${encodeURIComponent(e)}&language=pt-BR`,i=await fetch(n),c=await i.json();if(!i.ok||!(c.results.length>0))return{success:!1,error:"Filme n\xe3o encontrado"};{let u=c.results[0],l=`https://api.themoviedb.org/3/movie/${u.id}/credits?api_key=${a}&language=pt-BR`,p=await fetch(l),d=await p.json(),g=u.genre_ids.map(e=>{let a=o.find(a=>a.id===e);return a?a.name:"Desconhecido"});return{success:!0,data:{titulo:u.title,ano:u.release_date?new Date(u.release_date).getFullYear():"N/A",diretor:d.crew?d.crew.find(e=>"Director"===e.job)?.name:"N/A",generos:g,avaliacao:u.vote_average.toFixed(1),sinopse:u.overview,poster:`https://image.tmdb.org/t/p/w500${u.poster_path}`,elenco:d.cast}}}}g(decodeURIComponent(n)).then(e=>a.json({...e}));break;case"serie":async function h(e){let a="4e00066c2a5ca6f1b85b62150b3e5725",r=`https://api.themoviedb.org/3/genre/tv/list?api_key=${a}&language=pt-BR`,t=await fetch(r),s=await t.json(),o=s.genres||[],n=`https://api.themoviedb.org/3/search/tv?api_key=${a}&query=${encodeURIComponent(e)}&language=pt-BR`,i=await fetch(n),c=await i.json();if(!i.ok||!(c.results.length>0))return{success:!1,error:"S\xe9rie n\xe3o encontrada"};{let u=c.results[0],l=`https://api.themoviedb.org/3/tv/${u.id}/credits?api_key=${a}&language=pt-BR`,p=await fetch(l),d=await p.json(),g=u.genre_ids.map(e=>{let a=o.find(a=>a.id===e);return a?a.name:"Desconhecido"});return{success:!0,data:{titulo:u.name,ano:u.first_air_date?new Date(u.first_air_date).getFullYear():"N/A",diretor:d.crew?d.crew.find(e=>"Director"===e.job)?.name:"N/A",generos:g,avaliacao:u.vote_average.toFixed(1),sinopse:u.overview,poster:`https://image.tmdb.org/t/p/w500${u.poster_path}`,elenco:d.cast}}}}h(decodeURIComponent(n)).then(e=>a.json({...e}));break;case"letra":async function m(e){try{let a=`https://api.lyrics.ovh/suggest/${e}`,r=await fetch(a);if(!r.ok)throw Error("Erro na solicita\xe7\xe3o de sugest\xf5es de m\xfasicas");let t=await r.json();if(t.data&&t.data.length>0){let s=t.data[0];try{let o=`https://api.lyrics.ovh/v1/${encodeURIComponent(s.artist.name)}/${encodeURIComponent(s.title)}`,n=await fetch(o);if(!n.ok)throw Error("Erro na solicita\xe7\xe3o da letra da m\xfasica");let i=await n.json();if(i.lyrics)return{success:!0,data:{cantor:s.artist.name,titulo:s.title,letra:String(i.lyrics).replace(/^[^\r\n]*[\r\n]/,"").trim(),letrahtml:String(i.lyrics).replace(/^[^\r\n]*[\r\n]/,"").trim().replace(/\n/g,"<br>").replace(/\"/g,"&quot;")}};throw Error("Letra n\xe3o encontrada")}catch(c){return{success:!1,error:c.message}}}else throw Error("Nenhuma sugest\xe3o encontrada para o t\xedtulo da m\xfasica")}catch(u){return{success:!1,error:u.message}}}m(decodeURIComponent(n)).then(e=>a.json({...e}));break;case"musica":async function f(e){try{let a=`https://api.lyrics.ovh/suggest/${e}`,r=await fetch(a);if(!r.ok)throw Error("Erro na solicita\xe7\xe3o de sugest\xf5es de m\xfasicas");let t=await r.json();if(t.data&&t.data.length>0){let s=t.data[0],o={artista:s.artist.name,titulo:s.title,album:s.album.title,link:s.link,duracao:s.duration,preview:s.preview,rank:s.rank,capaAlbum:s.album.cover_big};return{success:!0,data:o}}throw Error("Nenhuma sugest\xe3o encontrada para o t\xedtulo da m\xfasica")}catch(n){return{success:!1,error:n.message}}}f(decodeURIComponent(n)).then(e=>a.json({...e}))}}),module.exports=router;